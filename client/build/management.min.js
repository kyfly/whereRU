app.controller("ActivityListCtrl",["$scope","Team","$rootScope",function(t,e,a){a.pageTitle="活动列表",t.chosenType="",t.unFormat="yyyy-MM-dd HH:mm",t.format="yyyy-MM-dd",e.prototype_get_activities({id:localStorage.$LoopBack$currentTeamId,filter:{where:{deleted:!1},order:"created DESC"}},function(e){t.activityItems=e},function(){Materialize.toast("获取活动列表失败！",6e3)}),t.deleteActivity=function(){var a=this;e.prototype_updateById_activities({id:localStorage.$LoopBack$currentTeamId,fk:a.activityItem.id},{deleted:!0},function(){Materialize.toast("删除成功！",2e3);var e=a.activityItem.id;for(var i in t.activityItems)t.activityItems[i].id===e&&t.activityItems.splice(i,1)},function(){Materialize.toast("删除失败！",2e3)})}}]),app.controller("ActivityEditCtrl",["$scope","Team","Ueditor","$location","$http","Activity","$stateParams","uploadFile","$timeout","$rootScope",function(t,e,a,i,o,r,d,c,n,m){var s=new Date;t.minDate=new Date(s.getTime()).toISOString(),t.month=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],t.monthShort=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],t.weekdaysFull=["周日","周一","周二","周三","周四","周五","周六"],t.weekdaysLetter=["日","一","二","三","四","五","六"],t.today="今天",t.clear="清除",t.close="确定",t.activityEditorConfig=a.config,t.activityData={authorName:t.teamInfo.name,authorId:t.teamInfo.id,type:t.teamInfo.type,school:t.teamInfo.school,created:new Date},t.startTime={},t.endTime={};var l=["mainInfo","copywriter","complete"];t.isEdit=d.id||!1,m.pageTitle=t.isEdit?"编辑活动":"新建活动",t.picNotice=t.isEdit?"如果要更换图片请上传,建议900*500像素":"请上传活动封面,建议900*500像素",t.preType={},d.id&&e.prototype_findById_activities({id:t.teamInfo.id,fk:d.id},function(e){t.activityData=e,t.activityEditorContent=e.explain;var a=new Date(e.started),i=new Date(e.ended);t.startTime.date=a,t.startTime.hour=a.getHours(),t.startTime.minute=a.getMinutes(),t.endTime.date=i,t.endTime.hour=i.getHours(),t.endTime.minute=i.getMinutes(),"common"!==e.actType&&(t.preType.type=e.actType,r["prototype_get_"+e.actType+"s"]({id:d.id},function(a){a[0]&&(t[e.actType+"Data"]=a[0],t.preType.id=a[0].id)}))}),t.hourChange=function(e){0===e?(t.startTime.hour>23?t.startTime.hour=23:t.startTime.hour<0&&(t.startTime.hour=0),t.startTime.hour=parseInt(t.startTime.hour)):(t.endTime.hour>23?t.endTime.hour=23:t.endTime.hour<0&&(t.endTime.hour=0),t.endTime.hour=parseInt(t.endTime.hour))},t.minuteChange=function(e){0===e?(t.startTime.minute>59?t.startTime.minute=59:t.startTime.minute<0&&(t.startTime.minute=0),t.startTime.minute=parseInt(t.startTime.minute)):(t.endTime.minute>59?t.endTime.minute=59:t.endTime.minute<0&&(t.endTime.minute=0),t.endTime.minute=parseInt(t.endTime.minute))},t.nextStep=function(t){$("#editActivityTabs").tabs("select_tab",l[t])},t.activityImgLoad=function(){var e=document.getElementById("activityImg").files[0],a=(new XMLHttpRequest,/\.[^\.]+/.exec(document.getElementById("activityImg").value.toLowerCase()));return".png"!==a[0]&&".jpg"!==a[0]&&".jpeg"!==a[0]&&".gif"!==a[0]?(alert("请确认您上传的logo文件格式是jpg、png、gif或jpeg"),!1):void c.img(e,"team",t.teamInfo.id).success(function(e){t.activityData.imgUrl=e.url})},t.getActivityList=function(a){e["prototype_get_"+a+"s"]({id:t.teamInfo.id},function(e){t[a+"Items"]=e.filter(function(t){return!(t.activityId||t.noticeId)})})},t.addFormFunc=function(){t.formData=this.formItem,$("#addForm").closeModal()},t.addVoteFunc=function(){t.voteData=this.voteItem,$("#addVote").closeModal()},t.addSeckillFunc=function(){return t.seckillData=this.seckillItem,t.seckillData.started<t.activityData.started?void Materialize.toast("抢票开始时间怎么能在活动开始前呢，记得修改噢",4e3):void $("#addSeckill").closeModal()},t.removeFormData=function(){t.formData=void 0},t.removeVoteData=function(){t.voteData=void 0},t.removeSeckillData=function(){t.seckillData=void 0},t.createActivity=function(){var a=new Date(t.startTime.date);a.setHours(t.startTime.hour),a.setMinutes(t.startTime.minute),a.setSeconds(0),t.activityData.started=a;var o=new Date(t.endTime.date);return o.setHours(t.endTime.hour),o.setMinutes(t.endTime.minute),o.setSeconds(0),t.activityData.ended=o,t.activityData.ended<t.activityData.started?void Materialize.toast("结束时间怎么能比开始时间早呢",4e3):(t.seckillData&&t.seckillData.started<t.activityData.started&&Materialize.toast("抢票开始时间在活动开始前，记得修改噢",4e3),void c.text(t.activityEditorContent,"team",t.teamInfo.id).success(function(a){t.activityData.explainUrl=a.url,t.activityData.team=void 0,t.formData?t.activityData.actType="form":t.voteData?t.activityData.actType="vote":t.seckillData?t.activityData.actType="seckill":t.activityData.actType="common",d.id?e.prototype_updateById_activities({id:localStorage.$LoopBack$currentTeamId,fk:d.id},t.activityData,function(e){Materialize.toast("更新成功！",2e3),t.formData?(t.formData.updated=new Date,t.formData.id=void 0,t.formData.activityId=d.id,t.formData.teamId=localStorage.$LoopBack$currentTeamId,"form"===t.preType.type?r.prototype_updateById_forms({id:e.id,fk:t.preType.id},t.formData):r.prototype_create_forms({id:e.id},t.formData)):"form"===t.preType.type&&r.prototype_delete_forms({id:e.id}),t.voteData?(t.voteData.updated=new Date,t.voteData.id=void 0,t.voteData.activityId=d.id,t.voteData.teamId=localStorage.$LoopBack$currentTeamId,"vote"===t.preType.type?r.prototype_updateById_votes({id:e.id,fk:t.preType.id},t.voteData):r.prototype_create_votes({id:e.id},t.voteData)):"vote"===t.preType.type&&r.prototype_delete_votes({id:e.id}),t.seckillData?(t.seckillData.updated=new Date,t.seckillData.id=void 0,t.seckillData.activityId=d.id,t.seckillData.teamId=localStorage.$LoopBack$currentTeamId,"seckill"===t.preType.type?r.prototype_updateById_seckills({id:e.id,fk:t.preType.id},t.seckillData):r.prototype_create_seckills({id:e.id},t.seckillData)):"seckill"===t.preType.type&&r.prototype_delete_seckills({id:e.id}),i.path("/MS/activity/list")},function(){Materialize.toast("更新失败！",2e3)}):e.prototype_create_activities({id:localStorage.$LoopBack$currentTeamId},t.activityData,function(e){Materialize.toast("创建成功！",2e3),t.formData?(t.formData.updated=new Date,t.formData.activityId=e.id,t.formData.id=void 0,t.formData.teamId=localStorage.$LoopBack$currentTeamId,r.prototype_create_forms({id:e.id},t.formData)):t.voteData?(t.voteData.updated=new Date,t.voteData.activityId=e.id,t.voteData.id=void 0,t.voteData.teamId=localStorage.$LoopBack$currentTeamId,r.prototype_create_votes({id:e.id},t.voteData)):t.seckillData&&(t.seckillData.updated=new Date,t.seckillData.activityId=e.id,t.seckillData.id=void 0,t.seckillData.teamId=localStorage.$LoopBack$currentTeamId,r.prototype_create_seckills({id:e.id},t.seckillData)),i.path("/MS/activity/list")},function(){Materialize.toast("创建失败！请不要漏填信息哦！",2e3)})}).error(function(){Materialize.toast("别忘了写活动文案哦！",2e3)}))}}]);
app.controller("AlbumCtrl",["$scope","$rootScope",function(o,l){l.logoHide=!1}]);
app.controller("EventListCtrl",["$scope","Team","$rootScope","Race",function(e,t,a,i){a.pageTitle="竞赛列表",e.unFormat="yyyy-MM-dd HH:mm",e.format="yyyy-MM-dd",t.prototype_get_races({id:e.teamInfo.id,filter:{where:{deleted:!1},order:"created DESC"}},function(t){e.eventItems=t},function(){Materialize.toast("获取创建竞赛列表失败！",6e3)}),t.prototype_get_partakedRaces({id:e.teamInfo.id,filter:{order:"created DESC"}},function(t){e.partakedEventItems=t},function(){Materialize.toast("获取参与竞赛列表失败！",2e3)});var n=new Date+2592e3;i.find({filter:{where:{or:[{started:{lt:n}},{ended:{gt:new Date}}],school:e.teamInfo.school}}},function(t){e.recommendRaces=t}),e.deleteEvent=function(){var a=this;t.prototype_updateById_races({id:e.teamInfo.id,fk:a.eventItem.id},{deleted:!0,updated:new Date},function(){Materialize.toast("删除成功！",2e3),delete a.eventItem},function(){Materialize.toast("删除失败！",2e3)})},e.quitEvent=function(){var e=this;t.prototype_unlink_partakedRaces({id:localStorage.$LoopBack$currentTeamId,fk:e.partakedEventItem.id},function(){Materialize.toast("删除成功！",2e3),delete e.partakedEventItem},function(){Materialize.toast("删除失败！",2e3)})},e.joinRace=function(){t.prototype_link_partakedRaces({id:e.teamInfo.id,fk:this.race.id},{},function(e){Materialize.toast("参与成功,刷新后可在参与列表查看",2e3)})}}]),app.controller("EventEditCtrl",["$scope","Team","Ueditor","$http","$location","uploadFile","$stateParams","$rootScope",function(e,t,a,i,n,o,r,d){e.eventData={authorName:e.teamInfo.name,authorId:e.teamInfo.id,school:e.teamInfo.school},e.startTime={},e.endTime={},e.isEdit=r.id||!1,d.pageTitle=e.isEdit?"编辑竞赛":"新建竞赛",e.picNotice=e.isEdit?"如果要更换图片请上传,建议900*500像素":"请上传活动封面,建议900*500像素",e.isEdit&&t.prototype_findById_races({id:e.teamInfo.id,fk:r.id},function(t){e.eventData=t,e.eventEditorContent=t.explain;var a=new Date(t.started),i=new Date(t.ended);e.startTime.date=a,e.startTime.hour=a.getHours(),e.startTime.minute=a.getMinutes(),e.endTime.date=i,e.endTime.hour=i.getHours(),e.endTime.minute=i.getMinutes()}),e.hourChange=function(t){0===t?(e.startTime.hour>23?e.startTime.hour=23:e.startTime.hour<0&&(e.startTime.hour=0),e.startTime.hour=parseInt(e.startTime.hour)):(e.endTime.hour>23?e.endTime.hour=23:e.endTime.hour<0&&(e.endTime.hour=0),e.endTime.hour=parseInt(e.endTime.hour))},e.minuteChange=function(t){0===t?(e.startTime.minute>59?e.startTime.minute=59:e.startTime.minute<0&&(e.startTime.minute=0),e.startTime.minute=parseInt(e.startTime.minute)):(e.endTime.minute>59?e.endTime.minute=59:e.endTime.minute<0&&(e.endTime.minute=0),e.endTime.minute=parseInt(e.endTime.minute))};var c=new Date;e.minDate=new Date(c.getTime()).toISOString(),e.month=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],e.monthShort=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],e.weekdaysFull=["周日","周一","周二","周三","周四","周五","周六"],e.weekdaysLetter=["日","一","二","三","四","五","六"],e.today="今天",e.clear="清除",e.close="确定";var m=["mainInfo","copywriter","complete"];e.nextStep=function(e){$("#editEventTabs").tabs("select_tab",m[e])},e.eventImgLoad=function(){var t=document.getElementById("eventImg").files[0],a=/\.[^\.]+/.exec(document.getElementById("eventImg").value.toLowerCase());return".png"!==a[0]&&".jpg"!==a[0]&&".jpeg"!==a[0]&&".gif"!==a[0]?(alert("请确认您上传的logo文件格式是jpg、png、gif或jpeg"),!1):void o.img(t,"team",e.teamInfo.id).success(function(t){e.eventData.imgUrl=t.url})},e.eventEditorConfig=a.config,e.createEvent=function(){var a=new Date(e.startTime.date);a.setHours(e.startTime.hour),a.setMinutes(e.startTime.minute),a.setSeconds(0),e.eventData.started=a;var i=new Date(e.endTime.date);i.setHours(e.endTime.hour),i.setMinutes(e.endTime.minute),i.setSeconds(0),e.eventData.ended=i,o.text(e.eventEditorContent,"team",e.teamInfo.id).success(function(a){e.eventData.explainUrl=a.url,e.eventData.created=new Date,e.eventData.deleted=!1,r.id?t.prototype_updateById_races({id:e.teamInfo.id,fk:r.id},e.eventData,function(){Materialize.toast("更新成功！",2e3),n.path("/MS/event/list")},function(){Materialize.toast("更新失败！",2e3)}):t.prototype_create_races({id:e.teamInfo.id},e.eventData,function(){Materialize.toast("创建成功！",2e3),n.path("/MS/event/list")},function(){Materialize.toast("创建失败！请不要漏填信息哦！",2e3)})}).error(function(){Materialize.toast("别忘了写竞赛介绍哦！",2e3)})}}]),app.controller("EventDetailCtrl",["$scope","Race","$http","$stateParams","uploadFile","Team","Notice","User","$rootScope",function(e,t,a,i,n,o,r,d,c){c.pageTitle="竞赛详情",e.isAuthor="author"===i.type,e.uploadAttachmentBtn=!1,e.addGetInfoBtn=!1,e.addNoticeForm=!1,e.submitResult=!1,e.newNotice={},e.materialInfo={loader:e.teamInfo.name,open:!0},t.findById({id:i.id},function(t){e.raceInfo=t}),e.materialLoad=function(){var t=document.getElementById("addMaterialDoc").files[0];n.file(t,"team",e.teamInfo.id).success(function(t){e.materialInfo.dataUrl=t.url}).error()},e.getActivityList=function(t){o["prototype_get_"+t+"s"]({id:e.teamInfo.id},function(a){e[t+"Items"]=a.filter(function(e){return!(e.activityId||e.noticeId)})})},e.addFormFunc=function(){e.formData=this.formItem,$("#addForm").closeModal()},e.removeFormData=function(){e.formData=void 0},e.createMaterial=function(){e.materialInfo.created=new Date,e.materialInfo.name?t.prototype_create_materials({id:i.id},e.materialInfo,function(t){Materialize.toast("上传成功！",2e3),e.materialInfo=void 0,e.materialList.push(t)},function(){Materialize.toast("上传失败！",2e3)}):Materialize.toast("请先选择一个文件哦！",2e3)},t.prototype_get_notices({id:i.id},function(t){e.noticeList=t},function(){Materialize.toast("获取通知列表失败！",2e3)}),e.deleteNotice=function(){var e=this;t.prototype_updateById_notices({id:i.id,fk:e.notice.id},{deleted:!0},function(){Materialize.toast("删除成功！",2e3),delete e.notice},function(){Materialize.toast("删除失败！",2e3)})},e.uploadAttachment=function(){var t=document.getElementById("attachmentFile").files[0];n.file(t,"team",e.teamInfo.id).success(function(t){e.newNotice.attachmentUrl=t.url}).error()},e.createNotice=function(){e.newNotice.created=new Date,e.newNotice.content?t.prototype_create_notices({id:i.id},e.newNotice,function(t){Materialize.toast("创建成功！",2e3),e.newNotice=void 0,e.formData&&(e.formData.updated=new Date,e.formData.noticeId=t.id,e.formData.id=void 0,e.formData.teamId=localStorage.$LoopBack$currentTeamId,t.form=e.formData,r.prototype_create_form({id:t.id},e.formData),e.formData=void 0),e.noticeList.push(t)},function(){Materialize.toast("创建失败！",2e3)}):Materialize.toast("请先填写通知内容哦",2e3)},e.uploadNoticeFile=function(){var t=document.getElementById(this.notice.id).files[0],a=this.notice;n.file(t,"team",e.teamInfo.id).success(function(t){a.dataUrl=t.url,e.putFileInfo(a)}).error()},e.putFileInfo=function(a){t.prototype_updateById_notices({id:i.id,fk:a.id},{name:a.file,dataUrl:a.dataUrl,created:new Date,loader:e.teamInfo.name,teamId:e.teamInfo.id},function(e){Materialize.toast("资料上传成功！",2e3)},function(e){Materialize.toast(e.data.error.message,2e3)})},e.initFormResult=function(){this.notice.showForm=!this.notice.showForm,this.notice.form._formItems.forEach(function(e){e.result=void 0})},e.submitResult=function(){var e=[],t={};this.notice.form._formItems.forEach(function(t){e.push({name:t.result,type:t.type})}),t.formId=this.notice.form.id,t.created=new Date,t.result=e,d.prototype_create_formResults({id:localStorage.$LoopBack$currentUserId},t,function(e){1e3===e.status||1100===e.status?Materialize.toast(e.message,2e3):Materialize.toast("表单提交成功",2e3)},function(e){})},t.prototype_get_raceTeams({id:i.id},function(t){e.raceTeams=t}),e.deleteRaceTeam=function(){var e=this;t.prototype_unlink_raceTeams({id:i.id,fk:e.raceTeam.id},function(){Materialize.toast("删除参赛团队成功！",2e3),delete e.raceTeam},function(){Materialize.toast("删除参赛团队失败！",2e3)})},t.prototype_get_materials({id:i.id},function(t){e.materialList=t},function(){Materialize.toast("获取资料列表失败！",6e3)}),e.deleteMaterial=function(){var e=this;t.prototype_destroyById_materials({id:i.id,fk:e.materialSingle.id},function(){Materialize.toast("删除资料成功！",2e3),delete e.materialSingle},function(){Materialize.toast("删除资料失败！",2e3)})},e.changeOpen=function(){var e=this;t.prototype_updateById_materials({id:i.id,fk:e.materialSingle.id},{open:e.materialSingle.open},function(){Materialize.toast("更改权限成功！",2e3)},function(){Materialize.toast("更改权限失败！",2e3)})}}]);
app.controller("FormListCtrl",["$scope","Team","$rootScope",function(t,e,o){o.pageTitle="表单列表",t.showType=0,e.prototype_get_forms({id:localStorage.$LoopBack$currentTeamId,filter:{order:"updated DESC"}},function(e){t.formItems=e,t.isActivity=function(e){return 0===t.showType?t.formItems[e].activityId||t.formItems[e].noticeId:!(t.formItems[e].activityId||t.formItems[e].noticeId)}},function(){Materialize.toast("获取表单列表失败！",6e3)}),t.deleteForm=function(){var o=this;e.prototype_destroyById_forms({id:localStorage.$LoopBack$currentTeamId,fk:o.formItem.id},function(){Materialize.toast("删除成功！",2e3);var e=o.formItem.id;for(var n in t.formItems)t.formItems[n].id===e&&t.formItems.splice(n,1)},function(){Materialize.toast("删除失败！",2e3)})}}]),app.controller("FormEditCtrl",["$scope","$location","Team","$rootScope","$stateParams",function(t,e,o,n,i){n.pageTitle="",t.isEdit=!1,""!==i.id?(t.isEdit=!0,o.prototype_findById_forms({id:localStorage.$LoopBack$currentTeamId,fk:i.id},function(e){t.uploadData=e,t.forms=e._formItems})):(t.forms=[],t.uploadData={teamId:localStorage.$LoopBack$currentTeamId}),t.formType=function(t){switch(t){case"text":return"简答题";case"select":return"选择题";case"textarea":return"陈述题";case"radio":return"判断题"}},t.addForm={choice:function(){t.forms.push({type:"select",name:"",options:["A-","B-","C-","D-"]})},simple:function(){t.forms.push({type:"text",name:"",options:[]})},complex:function(){t.forms.push({type:"textarea",name:"",options:[]})},judge:function(){t.forms.push({type:"radio",name:""})},file:function(){t.forms.push({type:"file",name:"",options:[]})},name:function(){t.forms.push({type:"text",name:"姓名",len:5,options:[]})},sex:function(){t.forms.push({type:"select",name:"性别",options:["男","女"]})},personalID:function(){t.forms.push({type:"text",name:"身份证号",len:18,options:[]})},hometown:function(){t.forms.push({type:"text",name:"籍贯",len:10,options:[]})},studentID:function(){t.forms.push({type:"text",name:"学号",len:8,options:[]})},school:function(){t.forms.push({type:"select",name:"学院",options:["机械工程学院","电子信息学院","通信工程学院","自动化学院","计算机学院","生命信息与仪器工程学院","材料与环境工程学院","软件工程学院","理学院","经济学院","管理学院","会计学院","外国语学院","数字媒体与艺术设计学院","人文与法学院","马克思主义学院","卓越学院","信息工程学院","国际教育学院","继续教育学院"]})},major:function(){t.forms.push({type:"text",name:"专业",len:20,options:[]})},email:function(){t.forms.push({type:"text",name:"电子邮箱",len:30,options:[]})},qqNumber:function(){t.forms.push({type:"text",name:"QQ号",len:15,options:[]})},longCellphoneNumber:function(){t.forms.push({type:"text",name:"手机长号",len:11,options:[]})},shortCellphoneNumber:function(){t.forms.push({type:"text",name:"移动短号",len:6,options:[]})},introduction:function(){t.forms.push({type:"textarea",name:"个人简介",len:200,options:[]})},specials:function(){t.forms.push({type:"textarea",name:"特长",len:100,options:[]})}},t.removeForm=function(e){t.forms.splice(e,1)},t.moveUpForm=function(){this.$index>0&&t.forms.splice(this.$index-1,0,t.forms.splice(this.$index,1)[0])},t.moveDownForm=function(){this.$index<t.forms.length&&t.forms.splice(this.$index+1,0,t.forms.splice(this.$index,1)[0])},t.appendContent=function(){t.forms[this.$parent.$parent.$index].options.push("")},t.removeContent=function(){t.forms[this.$parent.$parent.$parent.$index].options.splice(this.$index,1)},t.previewForm=function(){},t.uploadForm=function(){for(x in t.forms)t.forms[x].id=parseInt(x);t.uploadData.updated=new Date,t.uploadData._formItems=t.forms,0===t.forms.length?Materialize.toast("请至少添加一个表单项！",1e3):t.uploadData.title?t.isEdit?o.prototype_updateById_forms({id:localStorage.$LoopBack$currentTeamId,fk:i.id},t.uploadData,function(){Materialize.toast("修改成功！请在表单模板里查看",2e3),e.path("/MS/form/list")},function(t){Materialize.toast(t.data.error.message||"更新失败",2e3)}):o.prototype_create_forms({id:localStorage.$LoopBack$currentTeamId},t.uploadData,function(){Materialize.toast("创建成功！请在表单模板里查看",2e3),e.path("/MS/form/list")},function(t){Materialize.toast(t.data.error.message||"创建失败",2e3)}):Materialize.toast("请填写表单名称！",1e3)}}]),app.controller("FormResultCtrl",["$scope","$rootScope","$stateParams","Form","Team","$location",function(t,e,o,n,i,a){i.prototype_findById_forms({id:localStorage.$LoopBack$currentTeamId,fk:o.id},function(o){e.pageTitle="表单["+o.title+"]结果",t.form=o,t.url="http://"+a.host()+":"+a.port()+"/api/Forms/"+t.form.id+"/excel?access_token="+t.accesstoken}),n.prototype_get_formResults({id:o.id},function(e){t.results=e});var r="active";t.pageViewActive=r,t.pageView=function(){t.pageViewActive=r,t.allViewActive=!1},t.allViewActive=!1,t.allView=function(){t.pageViewActive=!1,t.allViewActive=r}}]);
app.controller("HelpCtrl",["$scope","$rootScope",function(o,e){e.logoHide=!1}]);
function AdminCtrl(e,i,a,l,d){l.pageTitle="首页",e.$on("$stateChangeStart",function(i,a,l){"index"!==a.name&&e.redirect(a.stateIndex)}),e.sidebars=[{id:"sidebarHome",display_name:"首页",url:"/MS/home"},{id:"sidebarMember",display_name:"成员管理",url:"/MS/member"},{id:"sidebarEvent",display_name:"竞赛管理",url:"/MS/event/list"},{id:"sidebarActivity",display_name:"活动管理",url:"/MS/activity/list"},{id:"sidebarForm",display_name:"表单管理",url:"/MS/form/list"},{id:"sidebarVote",display_name:"投票管理",url:"/MS/vote/list"},{id:"sidebarSeckill",display_name:"抢票管理",url:"/MS/seckill/list"},{id:"sidebarAlbum",display_name:"资料管理",url:"/MS/album"},{id:"sidebarSetting",display_name:"设置",url:"/MS/setting"},{id:"sidebarHelp",display_name:"帮助",url:"/MS/help"}],e.redirect=function(i){for(var a=0;a<e.sidebars.length;a++)e.sidebars[a].active=!1;e.sidebars[i].active=!0,$(".button-collapse").sideNav("hide")}}app.controller("AdminCtrl",["$scope","$timeout","$window","$rootScope","Team",AdminCtrl]),app.controller("HomeCtrl",["$scope",function(e){e.logoHide=!1}]);
app.controller("MemberCtrl",["$scope","Team","$rootScope",function(e,t,i){function o(){e.memberLength=0,e.members.forEach(function(t){t.verified===!0&&(e.memberLength=e.memberLength+1)})}i.pageTitle="成员管理",t.prototype_get_members({id:e.teamInfo.id},function(t){e.members=t,o()},function(){Materialize.toast("获取成员列表失败！",6e3)}),e.isShowMemberDetail=!1,e.showMemberDetail=function(){e.isShowMemberDetail=!e.isShowMemberDetail},e.agreeMemberIn=function(i){var o=this.member;t.prototype_updateById_members({id:e.teamInfo.id,fk:i},{verified:!0},function(){Materialize.toast("已经同意申请",2e3),o.verified=!0},function(){Materialize.toast("操作失败！",2e3)})},e.refuseMemberIn=function(i){var o=this;t.prototype_destroyById_members({id:e.teamInfo.id,fk:i},function(){Materialize.toast("已经拒绝申请",2e3),delete o.member},function(){Materialize.toast("操作失败！",2e3)})},e.deleteMember=function(){var i=this;t.prototype_destroyById_members({id:e.teamInfo.id,fk:this.member.id},function(){Materialize.toast("删除成功！",2e3),delete i.members[i.$index]},function(){Materialize.toast("删除失败！",2e3)})}}]);
app.controller("SeckillListCtrl",["$scope","Team","$rootScope",function(e,t,i){i.pageTitle="抢票列表",e.showType=0,t.prototype_get_seckills({id:localStorage.$LoopBack$currentTeamId,filter:{order:"updated DESC"}},function(t){e.seckillItems=t,e.isActivity=function(t){return 0===e.showType?e.seckillItems[t].activityId:!e.seckillItems[t].activityId}},function(){Materialize.toast("获取抢票列表失败！",6e3)}),e.deleteSeckill=function(){var i=this;t.prototype_destroyById_seckills({id:localStorage.$LoopBack$currentTeamId,fk:i.seckillItem.id},function(){Materialize.toast("删除成功！",2e3);var t=i.seckillItem.id;for(var a in e.seckillItems)e.seckillItems[a].id===t&&e.seckillItems.splice(a,1)},function(){Materialize.toast("删除失败！",2e3)})}}]),app.controller("SeckillEditCtrl",["$scope","$location","Team","$rootScope","$stateParams",function(e,t,i,a,l){e.startTime={},e.isEdit=!1,""!==l.id?(e.isEdit=!0,i.prototype_findById_seckills({id:localStorage.$LoopBack$currentTeamId,fk:l.id},function(t){e.uploadData=t,e.seckills=t._seckillItems;var i=new Date(t.started);e.startTime.date=i,e.startTime.hour=i.getHours(),e.startTime.minute=i.getMinutes()})):(e.seckills=[],e.uploadData={teamId:localStorage.$LoopBack$currentTeamId}),a.pageTitle=e.isEdit?"编辑抢票":"新建抢票";var s=new Date;e.minDate=new Date(s.getTime()).toISOString(),e.month=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],e.monthShort=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],e.weekdaysFull=["周日","周一","周二","周三","周四","周五","周六"],e.weekdaysLetter=["日","一","二","三","四","五","六"],e.today="今天",e.clear="清除",e.close="确定",e.hourChange=function(){e.startTime.hour>23?e.startTime.hour=23:e.startTime.hour<0&&(e.startTime.hour=0),e.startTime.hour=parseInt(e.startTime.hour)},e.minuteChange=function(){e.startTime.minute>59?e.startTime.minute=59:e.startTime.minute<0&&(e.startTime.minute=0),e.startTime.minute=parseInt(e.startTime.minute)},e.addSeckill=function(){e.seckills.push({name:""})},e.removeSeckill=function(t){e.seckills.splice(t,1)},e.moveUpSeckill=function(){this.$index>0&&e.seckills.splice(this.$index-1,0,e.seckills.splice(this.$index,1)[0])},e.moveDownSeckill=function(){this.$index<e.seckills.length&&e.seckills.splice(this.$index+1,0,e.seckills.splice(this.$index,1)[0])},e.appendContent=function(){e.seckills[this.$parent.$parent.$index].options.push("")},e.removeContent=function(){e.seckills[this.$parent.$parent.$parent.$index].options.splice(this.$index,1)},e.uploadSeckill=function(){for(x in e.seckills)e.seckills[x].id=parseInt(x);e.uploadData.updated=new Date;var a=new Date(e.startTime.date);a.setHours(e.startTime.hour),a.setMinutes(e.startTime.minute),a.setSeconds(0),e.uploadData.started=a,e.uploadData._seckillItems=e.seckills,0===e.seckills.length?Materialize.toast("请至少添加一个抢票项！",1e3):e.uploadData.title?e.isEdit?i.prototype_updateById_seckills({id:localStorage.$LoopBack$currentTeamId,fk:l.id},e.uploadData,function(){Materialize.toast("更新成功！请在抢票模板里查看",2e3),t.path("/MS/seckill/list")},function(e){Materialize.toast(e.data.error.message||"更新失败",2e3)}):i.prototype_create_seckills({id:localStorage.$LoopBack$currentTeamId},e.uploadData,function(){Materialize.toast("创建成功！请在抢票模板里查看",2e3),t.path("/MS/seckill/list")},function(e){Materialize.toast(e.data.error.message||"创建失败",2e3)}):Materialize.toast("请填写抢票名称！",1e3)}}]),app.controller("SeckillResultCtrl",["$scope","$rootScope","$stateParams","Seckill","Team",function(e,t,i,a,l){l.prototype_findById_seckills({id:localStorage.$LoopBack$currentTeamId,fk:i.id},function(i){t.pageTitle="["+i.title+"]结果",e.seckill=i}),a.prototype_get_seckillResults({id:i.id},function(t){e.results=t});var s="active";e.pageViewActive=s,e.pageView=function(){e.pageViewActive=s,e.allViewActive=!1},e.allViewActive=!1,e.allView=function(){e.pageViewActive=!1,e.allViewActive=s},e.queryInput=function(){e.query.verifyId||(e.query=void 0)}}]);
app.controller("SettingCtrl",["$scope","$rootScope","Team","uploadFile",function(e,t,a,n){t.logoHide=!1,e.team={},a.findById({id:localStorage.$LoopBack$currentTeamId},function(t){e.team=t}),e.types=[{name:"校园组织"},{name:"校园团队"},{name:"兴趣团队"},{name:"技术团队"}],e.uploadLogo=function(){var t=document.getElementById("teamlogo").files[0];if(t){var a=/\.[^\.]+/.exec(document.getElementById("teamlogo").value.toLowerCase());return".png"!==a[0]&&".jpg"!==a[0]&&".jpeg"!==a[0]&&".gif"!==a[0]?(alert("请确认您上传的logo文件格式是jpg、png、gif或jpeg"),!1):void n.img(t,"team",e.teamInfo.id).success(function(t){e.team.logoUrl=t.url})}},e.addDepartment=function(){e.team.teamDepartments.push({name:"",desc:""})},e.moveUpDepartment=function(t){t>0&&e.team.teamDepartments.splice(t-1,0,e.team.teamDepartments.splice(t,1)[0])},e.moveDownDepartment=function(t){t<e.team.teamDepartments.length&&e.team.teamDepartments.splice(t+1,0,e.team.teamDepartments.splice(t,1)[0])},e.removeDepartment=function(t){e.team.teamDepartments.splice(t,1)},e.updateInfo=function(){e.team.updated=new Date;var t=[];if(e.team.teamDepartments.length)for(var n=0;n<e.team.teamDepartments.length;n++)t.push(e.team.teamDepartments[n]),t[n].id=n;console.log(e.team),a.prototype_updateAttributes({id:localStorage.$LoopBack$currentTeamId},e.team,function(){Materialize.toast("更新成功！",2e3)},function(){Materialize.toast("更新失败！",2e3)})}}]);
function sort(t){var e=0,o=t.length-1,i=function(e,o){if(e!=o){for(var a=t[e].count,n=e,s=o;o>e;)if(t[o].count>=a)o--;else for(t[e].count=t[o].count;o>++e;)if(t[e].count>a){t[o].count=t[e].count;break}if(n==e)return void i(++e,s);t[e].count=a,i(n,e),i(o,s)}};return i(e,o),t}app.controller("VoteListCtrl",["$scope","Team","$rootScope",function(t,e,o){o.pageTitle="投票列表",t.showType=0,e.prototype_get_votes({id:localStorage.$LoopBack$currentTeamId,filter:{order:"updated DESC"}},function(e){t.voteItems=e,t.isActivity=function(e){return 0===t.showType?t.voteItems[e].activityId:!t.voteItems[e].activityId}},function(){Materialize.toast("获取投票列表失败！",6e3)}),t.deleteVote=function(){var o=this;e.prototype_destroyById_votes({id:localStorage.$LoopBack$currentTeamId,fk:o.voteItem.id},function(){Materialize.toast("删除成功！",2e3);var e=o.voteItem.id;for(var i in t.voteItems)t.voteItems[i].id===e&&t.voteItems.splice(i,1)},function(){Materialize.toast("删除失败！",2e3)})}}]),app.controller("VoteEditCtrl",["$scope","$location","Team","$rootScope","$stateParams","uploadFile",function(t,e,o,i,a,n){t.isEdit=!1,""!==a.id?(t.isEdit=!0,o.prototype_findById_votes({id:localStorage.$LoopBack$currentTeamId,fk:a.id},function(e){t.uploadData=e,t.votes=e._voteItems})):(t.votes=[],t.uploadData={teamId:localStorage.$LoopBack$currentTeamId}),i.pageTitle=t.isEdit?"编辑投票":"新建投票",t.addVote=function(){t.votes.push({name:""})},t.removeVote=function(e){t.votes.splice(e,1)},t.moveUpVote=function(){this.$index>0&&t.votes.splice(this.$index-1,0,t.votes.splice(this.$index,1)[0])},t.moveDownVote=function(){this.$index<t.votes.length&&t.votes.splice(this.$index+1,0,t.votes.splice(this.$index,1)[0])},t.appendContent=function(){t.votes[this.$parent.$parent.$index].options.push("")},t.removeContent=function(){t.votes[this.$parent.$parent.$parent.$index].options.splice(this.$index,1)},t.uploadImg=function(){var e=this.vote,o=document.getElementById("vote_"+this.$index).files[0];if(o){var i=/\.[^\.]+/.exec(document.getElementById("vote_"+this.$index).value.toLowerCase());return".png"!==i[0]&&".jpg"!==i[0]&&".jpeg"!==i[0]&&".gif"!==i[0]?(alert("请确认您上传的logo文件格式是jpg、png、gif或jpeg"),!1):void n.img(o,"team",t.teamInfo.id).success(function(t){e.imgUrl=t.url})}},t.uploadVote=function(){for(x in t.votes)t.votes[x].id=parseInt(x);t.uploadData.updated=new Date,t.uploadData._voteItems=t.votes,0===t.votes.length?Materialize.toast("请至少添加一个投票项！",1e3):t.uploadData.title?t.uploadData.max||t.uploadData.limit?t.isEdit?o.prototype_updateById_votes({id:localStorage.$LoopBack$currentTeamId,fk:a.id},t.uploadData,function(){Materialize.toast("修改成功！请在投票模板里查看",2e3),e.path("/MS/vote/list")},function(t){Materialize.toast(t.data.error.message||"更新失败",2e3)}):o.prototype_create_votes({id:localStorage.$LoopBack$currentTeamId},t.uploadData,function(){Materialize.toast("创建成功！请在投票模板里查看",2e3),e.path("/MS/vote/list")},function(t){Materialize.toast(t.data.error.message||"创建失败",2e3)}):Materialize.toast("请填写投票票数限制！",1e3):Materialize.toast("请填写投票名称！",1e3)}}]),app.controller("VoteResultCtrl",["$scope","$rootScope","$stateParams","Vote","Team",function(t,e,o,i,a){a.prototype_findById_votes({id:localStorage.$LoopBack$currentTeamId,fk:o.id},function(o){e.pageTitle="["+o.title+"]结果",t.vote=o,t.sum=0,t.vote._voteItems=sort(t.vote._voteItems),t.vote._voteItems.forEach(function(e){t.sum+=e.count,e.point=e.count/t.vote._voteItems[t.vote._voteItems.length-1].count*100})}),t.ASCActive="active",t.DESCActive=!1,t.ASC=function(){t.DESCActive=!1,t.ASCActive="active",t.desc=!1},t.DESC=function(){t.DESCActive="active",t.ASCActive=!1,t.desc=!0}}]);