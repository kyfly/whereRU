app.controller("ActivitiesController",["$scope","Activity",function(t,e){function i(t){var e=new Date;t.ended<e?t.status="end":t.started>e?t.status="nos":t.status="ing"}t.activityFilter=["全部","进行中","未开始","已结束"],t.choice="全部",t.changeFilter=function(){t.choice=this.filter},t.filterFun=function(e){switch(t.choice){case"全部":return!0;case"进行中":if("ing"===e.status)return!0;case"未开始":if("nos"===e.status)return!0;case"已结束":if("end"===e.status)return!0}},t.$currentUser?e.getMySchoolActiveties({school:t.$currentUser.school},function(e){for(x in e)"activties"===x&&(t.activityItems=e[x],t.activityItems.forEach(function(t){i(t)}))},function(e){t.errorTip(e)}):e.find(function(e){t.activityItems=e,t.activityItems.forEach(function(t){i(t)})},function(e){t.errorTip(e)})}]),app.controller("ActivityController",["$scope","Activity","User","$stateParams","$interval",function(t,e,i,r,o){function n(t){var e=t%60,i=Math.floor(t/86400),r=Math.floor((t-3600*i*24)/3600),o=Math.floor((t-3600*i*24-3600*r)/60);return{d:i,h:r,m:o,s:e}}e.findById({id:r.id},function(i){t.activity=i,t.$emit("shareContentArrive",{bdText:i.title,bdDesc:i.keyword,bdPic:i.imgUrl}),"common"!==i.actType&&e["prototype_get_"+i.actType+"s"]({id:r.id},function(e){if(t[i.actType]=e[0],"seckill"===i.actType){var r=Math.floor((new Date(t.seckill.started)-new Date(t.seckill.serverTime))/1e3),s=n(r);t.countDown=r,t.seckillTime=s;var a=o(function(){r--;var e=r%60,i=Math.floor(r/86400),n=Math.floor((r-3600*i*24)/3600),s=Math.floor((r-3600*i*24-3600*n)/60);t.seckillTime={d:i,h:n,m:s,s:e},0>=r&&o.cancel(a)},1e3);t.$on("$destroy",function(){o.cancel(a)})}},function(e){t.errorTip(e)})},function(e){t.errorTip(e)}),t.onClickJoinActivity=function(){var e=t.activity.actType;"common"!==e&&(t.result=new Array(t[e]["_"+e+"Items"].length))},t.checkedForVote=function(){var e=t.result.filter(function(t){return t});return e.length>t.vote.max?(this.result[this.$index]=void 0,void Materialize.toast("只能选择"+t.vote.max+"项哦",2e3)):void(this.result[this.$index]?this.voteIteam.count++:this.voteIteam.count--)},t.submitFormResult=function(){if(!t.$currentUser)return t.$emit("auth:loginRequired");for(var e in t.form._formItems)"select"===t.form._formItems[e].type?(t.result[e].type="selelct",t.result[e].name=t.result[e].option,t.result[e].option=void 0):t.result[e].type=t.form._formItems[e].type;var r={verifyId:t.verifyId,formId:t.form.id,created:new Date,result:t.result};i.prototype_create_formResults({id:t.$currentUser.id},r,function(t){Materialize.toast("参与成功",2e3)},function(e){t.errorTip(e)})},t.submitVoteResult=function(){var e=[];if(!t.$currentUser)return t.$emit("auth:loginRequired");if(t.activity.verifyRule&&!t.verifyId)return void Materialize.toast("验证规则必须填",2e3);for(var r in t.result)t.result[r]&&e.push(t.vote._voteItems[r].id);if(e.length>t.vote.max)return void Materialize.toast("只能选择"+t.vote.max+"项哦",2e3);if(e.length<=0)return void Materialize.toast("至少选择一项哦",2e3);var o={verifyId:t.verifyId,voteId:t.vote.id,created:new Date,result:e};i.prototype_create_voteResults({id:t.$currentUser.id},o,function(t){1e3===t.status?Materialize.toast(t.message,2e3):Materialize.toast("参与成功",2e3)},function(e){t.errorTip(e)})},t.submitSeckillResult=function(){if(!t.$currentUser)return t.$emit("auth:loginRequired");var e={created:new Date,verifyId:t.verifyId,itemId:this.seckillItem.id,seckillId:t.seckill.id};i.prototype_create_seckillResults({id:t.$currentUser.id},e,function(t){1e3===t.status||1100===t.status?Materialize.toast(t.message,2e3):Materialize.toast("恭喜你,抢到了",2e3)},function(e){t.errorTip(e)})}}]);
app.config(["$stateProvider","$urlRouterProvider",function(t,i){i.when("","/application/views/activity/index.html"),t.state("art.activities",{url:"/activities",controller:"ActivitiesController",templateUrl:"/application/views/activity/index.html"}).state("art.activity",{url:"/:id/detail",controller:"ActivityDetailController",templateUrl:"/application/views/activity/detail.html"}).state("activity",{url:"/w/activities/:id",controller:"ActivityController",templateUrl:"application/views/activity/detail.html"})}]);
app.controller("CoteriesController",["$scope","User","Coterie","$location",function(e,t,r,i){function o(){t.prototype_get_coteries({id:e.$currentUser.id},function(t){e.coteries=t,t.length&&!i.path().match(/\/w\/coteries\/.+/)&&i.path("/w/coteries/"+e.coteries[0].id)})}e.more=!1,e.moreOrBack=e.more?"返回":"发现",e.goLogin=function(){return e.$currentUser?void 0:e.$emit("auth:loginRequired")},e.moreCoteries=function(){if(e.more=!e.more,e.more)r.find(function(t){e.coteries=t});else{if(!e.$currentUser)return e.$emit("auth:loginRequired");o()}e.moreOrBack=e.more?"返回":"发现"},e.$currentUser&&o()}]),app.controller("CoterieController",["$scope","$stateParams","Coterie","User","Ueditor","$http","$location",function(e,t,r,i,o,n,c){r.findById({id:t.id},function(r){e.coterie=r,e.$emit("shareContentArrive",{bdText:r.name,bdPic:r.logoUrl}),r.isAttentioned&&i.prototype_updateById_coteries({id:e.$currentUser.id,fk:t.id},{lastView:new Date},function(e){},function(e){console.log(e)})}),r.prototype_get_articles({id:t.id},function(t){e.articles=t},function(){}),e.editorConfig=o.config,e.article={},e.createArticle=function(){if(!e.$currentUser)return e.$emit("auth:loginRequired");var r=e.articleEditorContent,o=e.article.title;return r&&o?void n({url:"/ue/uploads?dir=user&id="+e.$currentUser.id+"&action=uploadtext",method:"post",data:{content:e.articleEditorContent}}).success(function(r){e.article.contentUrl="http://oss.etuan.org/"+r.url,e.article.created=new Date,e.article.coterieId=t.id,i.prototype_create_articles({id:e.$currentUser.id},e.article,function(e){console.log(e),Materialize.toast("文章发布成功",2e3),c.path("/w/coteries/"+t.id)})}):void Materialize.toast("文章标题和内容都不能为空",2e3)},e.attention=function(){return e.$currentUser?void i.prototype_create_coteries({id:e.$currentUser.id},{lastView:new Date,coterieId:t.id},function(t){e.coterie.isAttentioned=!0,Materialize.toast("关注成功！",2e3)},function(e){console.log(e),Materialize.toast("关注失败！",2e3)}):e.$emit("auth:loginRequired")},e.addLike=function(){if(!e.$currentUser)return e.$emit("auth:loginRequired");var t=this.article;i.prototype_create_likeUsers({id:e.$currentUser.id},{articleId:t.id,created:new Date},function(e){1===e.status?(t.likeCount++,t.islike=!0,Materialize.toast("文章标记为喜欢",2e3)):Materialize.toast("文章已经被标记为喜欢",2e3)})}}]),app.controller("ArticlesController",["$scope","Article",function(e,t){e.loadComment=function(){var e=this.article;return this.article.commentTextarea=!0,e.showCommentBox?void(e.showCommentBox=!1):(t.prototype_get_comments({id:e.id},function(t){e.comments=t}),void(e.showCommentBox=!0))}}]),app.controller("CommentsController",["$scope","Comment","User",function(e,t,r){e.createComment=function(){var t=this.article;return e.$currentUser?t.writingCommentContent?void r.prototype_create_comments({id:e.$currentUser.id},{articleId:t.id,created:new Date,content:t.writingCommentContent},function(r){r.user={headImgUrl:e.$currentUser.headImgUrl,id:e.$currentUser.id,name:e.$currentUser.name},t.commentCount++,r.replyCount=0,t.comments.push(r),t.writingCommentContent=null,Materialize.toast("评论成功",2e3)}):void Materialize.toast("请先输入评论内容",2e3):e.$emit("auth:loginRequired")},e.loadReply=function(){var e=this.comment;t.prototype_get_replys({id:this.comment.id},function(t){e.replys=t})},e.createReply=function(){var t=this.comment;return e.$currentUser?t.writingReplyContent?void r.prototype_create_replys({id:e.$currentUser.id},{commentId:t.id,created:new Date,content:t.writingReplyContent},function(r){r.user={id:e.$currentUser.id,name:e.$currentUser.name},t.replyCount++,t.replys.push(r),t.writingReplyContent=null,Materialize.toast("回复成功",2e3)}):void Materialize.toast("请先输入回复内容",2e3):e.$emit("auth:loginRequired")}}]),app.controller("ArticleController",["$scope","$stateParams","User","Coterie","Article","Comment",function(e,t,r,i,o,n){e.$currentUser||(e.$currentUser={},e.$currentUser.id=0),o.findById({id:t.id},function(r){e.article=r,e.$emit("shareContentArrive",{bdText:r.title}),o.prototype_get_comments({id:t.id},function(t){e.article.comments=t}),e.article.showCommentBox=!0}),o.prototype_create_readers({id:t.id},{userId:e.$currentUser.id,form:"pc"})}]);
app.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("coteries",{url:"/w/coteries",controller:"CoteriesController",templateUrl:"application/views/coterie/index.html"}).state("coteries.articles",{url:"/:id",controller:"CoterieController",templateUrl:"application/views/coterie/detail.html"}).state("edit",{url:"/w/articles/:id/edit",controller:"CoterieController",templateUrl:"application/views/coterie/edit.html"}).state("coterie",{url:"/w/coteries/:id/articles",controller:"CoterieController",templateUrl:"application/views/coterie/detail.html"}).state("article",{url:"/w/articles/:id",controller:"ArticleController",templateUrl:"application/views/coterie/article.html"})}]);
app.controller("RacesController",["$scope","Race",function(e,t){e.username?t.getMySchoolRaces({school:e.$currentUser.school},function(t){for(x in t)"races"===x&&(e.raceItems=t[x])}):t.find(function(t){e.raceItems=t})}]),app.controller("RaceController",["$scope","Race","$stateParams","User","Team",function(e,t,o,r,n){t.findById({id:o.id},function(t){e.race=t,e.$emit("shareContentArrive",{bdText:t.name,bdPic:t.imgUrl})}),t.prototype_get_notices({id:o.id},function(t){e.notices=t}),t.prototype_get_raceTeams({id:o.id},function(t){e.raceTeams=t}),e.$currentUser&&r.prototype_get_teams({id:e.$currentUser.id},function(t){e.teams=t}),e.selectedTeam=function(){e.selected=this.team.id},e.joinRace=function(){return e.$currentUser?e.selected?void n.prototype_link_partakedRaces({id:e.selected,fk:o.id},{},function(e){Materialize.toast("参与成功,请经常关注竞赛信息",2e3)}):Materialize.toast("必须选择一个团队",2e3):e.$emit("auth:loginRequired")}}]);
app.config(["$stateProvider","$urlRouterProvider",function(e,r){e.state("art.races",{url:"/races",controller:"RacesController",templateUrl:"application/views/race/index.html"}).state("race",{url:"/w/races/:id",controller:"RaceController",templateUrl:"application/views/race/detail.html"})}]);
app.controller("TeamsController",["$scope","Team","User","$location",function(e,t,n,o){e.types=[{name:"校园组织"},{name:"校园团队"},{name:"兴趣团队"},{name:"技术团队"}],e.changeFilter=function(){e.choice=this.type.name},e.team={status:!1,hidden:!1},e.uploadLogo=function(){if(!e.$currentUser)return e.$emit("auth:loginRequired");var t=document.getElementById("teamlogo").files[0],n=new XMLHttpRequest,o=/\.[^\.]+/.exec(document.getElementById("teamlogo").value.toLowerCase());if(".png"!==o[0]&&".jpg"!==o[0]&&".jpeg"!==o[0]&&".gif"!==o[0])return alert("请确认您上传的logo文件格式是jpg、png、gif或jpeg"),!1;var a=function(){4===n.readyState&&200===n.status&&e.$apply(function(){e.team.logoUrl="http://cdn-img.etuan.org/"+JSON.parse(n.responseText).url+"@1e_1c_0o_0l_100h_100w_100q.src"})},r=new FormData;r.append("img",t),n.onreadystatechange=a,n.open("POST","/ue/uploads?dir=teamlogo&id="+e.$currentUser.id+"&action=uploadimage",!0),n.send(r)},e.username?t.getMySchoolTeams({school:e.$currentUser.school},function(t){e.teams=t.teams}):t.find(function(t){e.teams=t}),e.createTeam=function(){return e.$currentUser?void n.prototype_create_teams({id:e.$currentUser.id},e.team,function(e){Materialize.toast("创建团队成功",2e3),o.path("/w/teams/"+e.id)}):e.$emit("auth:loginRequired")}}]),app.controller("TeamController",["$scope","Team","$stateParams","User",function(e,t,n,o){e.userInfomation={},e.teamId||(e.teamId=n.id),e.$currentUser&&o.getInfo(function(t){e.user=t}),t.findById({id:e.teamId},function(t){e.team=t,e.$emit("shareContentArrive",{bdText:t.name,bdPic:t.logoUrl,bdDesc:t.desc})},function(){}),t.prototype_get_activities({id:e.teamId},function(t){e.activities=t}),e.join=function(){return e.$currentUser?void t.prototype_create_members({id:e.teamId},e.userInfomation,function(e){Materialize.toast("申请成功,等待管理员同意",2e3)},function(e){console.log(e),Materialize.toast(e.data.error.message,2e3)}):e.$emit("auth:loginRequired")}}]);
app.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("art.teams",{url:"/teams",controller:"TeamsController",templateUrl:"application/views/team/index.html"}).state("create",{url:"/w/teams/create",controller:"TeamsController",templateUrl:"application/views/team/create.html"}).state("team",{url:"/w/teams/:id",controller:"TeamController",templateUrl:"application/views/team/detail.html"})}]);
app.controller("LoginController",["User","$scope","$location","LoopBackAuth","$window","$rootScope",function(e,t,r,o,i,n){t.user={},t.login=function(){e.login(t.user,function(e){e.user.id=e.userId,o.setUser(e.id,e.userId,e.user),o.save(),localStorage.$LoopBack$currentUserToken=JSON.stringify(e),Materialize.toast("登录成功",2e3),i.location.href=r.path()},function(e){Materialize.toast("登录失败,请检查输入是否正确",2e3)})}}]),app.controller("RegisterController",["User","School","$scope","$rootScope","$location","LoopBackAuth",function(e,t,r,o,i,n){r.user={},t.find(function(e){r.schools=e}),r.register=function(){e.create(r.user,function(e){e.user.id=e.userId,o.$currentUser=e.user,o.username=e.user.name,n.setUser(e.id,e.userId,e.user),n.save(),localStorage.$LoopBack$currentUserToken=JSON.stringify(e),Materialize.toast("恭喜你，注册成功",2e3),i.path("/w/activities").replace()},function(e){1e3===e.status&&Materialize.toast("该手机号已经被注册",2e3)})}}]),app.controller("ConfirmSchoolController",["User","$scope",function(e,t){t.confirm=function(){e.confirmSchool({id:localStorage.$LoopBack$currentUserId},t.user,function(){})}}]),app.controller("UserController",["$scope","User","$rootScope","$location",function(e,t,r,o){var i=function(){t.getMyTeams({id:e.$currentUser.id},function(t){e.teams=t.teams})},n=function(){t.getRaceHistories({id:e.$currentUser.id},function(t){e.races=t.races})},c=function(){t.getActivitiesHistories({id:e.$currentUser.id},function(t){e.activities=t.activities})},a=function(){t.getLikeArticles({id:e.$currentUser.id},function(t){e.likeArticles=t.articles})},s=function(){t.prototype_get_articles({id:e.$currentUser.id},function(t){e.articles=t})};e.goLogin=function(){return e.$currentUser?void 0:e.$emit("auth:loginRequired")},e.activeMenus=[{name:"我的团队",clickFn:i,active:!0,eName:"team"},{clickFn:n,name:"参赛竞赛",active:!1,eName:"race"},{clickFn:c,name:"活动历史",active:!1,eName:"activity"},{clickFn:a,name:"喜欢文章",active:!1,eName:"article"}],e.logout=function(){r.$currentUser=null,localStorage.$LoopBack$currentUserToken="",localStorage.$LoopBack$accessTokenId="",r.username=!1,Materialize.toast("退出成功",2e3),o.path("/w/activities")},e.pullData=function(){return e.$currentUser?(e.activeMenus.forEach(function(e){e.active=!1}),this.menu.active=!0,this.menu.clickFn(),void(e.selectedMenu=this.menu.eName)):e.$emit("auth:loginRequired")},e.selectedMenu="team",e.$currentUser?(t.getInfo(function(t){e.user=t}),i(),s()):e.user=null}]),app.controller("ActivityResultController",["$scope","$stateParams","User",function(e,t,r){return e.$currentUser?void r["prototype_findById_"+t.type+"Results"]({id:e.$currentUser.id,fk:t.id},function(t){e.results=t.result,e.activity=t.activity}):e.$emit("auth:loginRequired")}]),app.controller("MSController",["User","$stateParams",function(e,t){window.localStorage.$LoopBack$currentTeamId=t.id,window.location.href="/MS"}]),app.controller("ARTController",["$scope",function(){}]);
app.config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("confirmSchool",{url:"/w/confirmSchool",controller:"ConfirmSchoolController",templateUrl:"application/views/confirm-school.html"}).state("register",{url:"/u/register",controller:"RegisterController",templateUrl:"application/views/user/register.html"}).state("index",{url:"/",controller:"HomeController",templateUrl:"/application/views/index.html"}).state("home",{url:"/u/home",controller:"UserController",templateUrl:"/application/views/user/index.html"}).state("activityResult",{url:"/u/results/:id/:type",controller:"ActivityResultController",templateUrl:"/application/views/user/activity-result.html"}).state("MS",{url:"/w/team/:id",controller:"MSController",template:"<div></div>"}).state("art",{url:"/w",controller:"ARTController",template:"<div ui-view></div>"})}]);