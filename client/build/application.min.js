app.controller("ActivitiesController",["$scope","Activity","$window",function(t,e,i){function r(t){var e=new Date;try{new Date(t.ended)<e?t.status="end":new Date(t.started)>e?t.status="nos":t.status="ing"}catch(i){}return t}t.activityFilter=["全部","进行中","未开始","已结束"],t.choice="全部",i.pull=!0,t.activityItems=[],t.filterBar="ng-hide";var a=0,s=0;t.changeFilter=function(){t.choice=this.filter},angular.element(i).bind("scroll",function(e){var r=e.target.body;r.scrollHeight-r.clientHeight-r.scrollTop<600&&i.pull&&!t.last?(t.getActivities(),i.pull=!1):r.scrollHeight-r.clientHeight-r.scrollTop>600&&(i.pull=!0)}),t.$on("$destroy",function(e,r){angular.element(i).unbind("scroll"),t.activityItems=void 0}),t.formFilter=function(){t.query={actType:"form"},a=0,t.last=!1,t.activityItems=[],t.getActivities(),t.typeHide=!0,t.type="表单"},t.voteFilter=function(){t.query={actType:"vote"},a=0,t.last=!1,t.activityItems=[],t.getActivities(),t.typeHide=!0,t.type="投票"},t.seckillFilter=function(){t.query={actType:"seckill"},a=0,t.last=!1,t.activityItems=[],t.getActivities(),t.typeHide=!0,t.type="抢票"},t.allTypeFilter=function(){t.query=void 0,t.typeHide=!0,t.type="类型"},t.allStatusFilter=function(){t.query=void 0,t.status="状态",t.statusHide=!0},t.ingFilter=function(){t.query={status:"ing"},t.statusHide=!0,s=1,a=0,t.last=!1,t.activityItems=[],t.getActivities(),t.status="进行中"},t.nosFilter=function(){t.query={status:"nos"},t.statusHide=!0,s=2,a=0,t.last=!1,t.activityItems=[],t.getActivities(),t.status="未开始"},t.endFilter=function(){t.query={status:"end"},t.statusHide=!0,s=-1,a=0,t.last=!1,t.activityItems=[],t.getActivities(),t.status="已结束"},t.titleFilter=function(){filterTitle?t.query={title:filterTitle}:t.query=void 0},t.getActivities=function(){if(!t.$currentUser)return void t.$emit("auth:loginRequired");var i=t.query||{},n=i.actType||"all";e.getMySchoolActiveties({school:t.$currentUser.school,actType:n,status:s,page:a},function(e){for(x in e)"activties"===x&&(a++,(e[x].length<16||0===e[x].length)&&(t.last=!0),e[x].forEach(function(e){t.activityItems.push(r(e))}))})},t.$currentUser?t.getActivities():e.find(function(e){t.activityItems=e,t.activityItems.forEach(function(t){r(t)})})}]),app.controller("ActivityController",["$scope","Activity","User","$stateParams","$interval","uploadFile","$location",function(t,e,i,r,a,s,n){function o(t){var e=t%60,i=Math.floor(t/86400),r=Math.floor((t-3600*i*24)/3600),a=Math.floor((t-3600*i*24-3600*r)/60);return{d:i,h:r,m:a,s:e}}e.findById({id:r.id},function(i){t.activity=i,t.$emit("shareContentArrive",{bdText:i.title,bdDesc:i.keyword,bdPic:i.imgUrl}),"common"!==i.actType&&e["prototype_get_"+i.actType+"s"]({id:r.id},function(e){if(t[i.actType]=e[0],"seckill"===i.actType){var r=Math.floor((new Date(t.seckill.started)-new Date(t.seckill.serverTime))/1e3),s=o(r);t.countDown=r,t.seckillTime=s;var n=a(function(){r--;var e=r%60,i=Math.floor(r/86400),s=Math.floor((r-3600*i*24)/3600),o=Math.floor((r-3600*i*24-3600*s)/60);t.seckillTime={d:i,h:s,m:o,s:e},0>=r&&a.cancel(n)},1e3);t.$on("$destroy",function(){a.cancel(n)})}})}),t.onClickJoinActivity=function(){var e=t.activity.actType;t.activityEnded=!1,t.$currentUser||t.$emit("auth:loginRequired"),"学号"===t.activity.verifyRule?t.activity.verifyId=t.$currentUser.studentId:"手机"===t.activity.verifyRule&&(t.activity.verifyId=t.$currentUser.phone),"common"!==e&&(t.result=new Array(t[e]["_"+e+"Items"].length)),new Date-new Date(t.activity.ended)>0&&(t.activityEnded=!0)},t.checkedForVote=function(){var e=t.result.filter(function(t){return t});return t.vote.max&&e.length>t.vote.max?(this.result[this.$index]=void 0,void Materialize.toast("只能选择"+t.vote.max+"项哦",2e3)):void(this.result[this.$index]?this.voteIteam.count++:this.voteIteam.count--)},t.submitFormResult=function(){if(!t.$currentUser)return t.$emit("auth:loginRequired");if(t.activity.verifyRule&&!t.activity.verifyId)return void Materialize.toast("验证规则必须填",2e3);for(var e in t.form._formItems)"select"===t.form._formItems[e].type?(t.result[e].type="selelct",t.result[e].name=t.result[e].option,t.result[e].option=void 0):t.result[e].type=t.form._formItems[e].type;var r={verifyId:t.activity.verifyId,formId:t.form.id,created:new Date,result:t.result};i.prototype_create_formResults({id:t.$currentUser.id},r,function(t){1e3===t.status||1100===t.status?Materialize.toast(t.message,2e3):Materialize.toast("参与成功,可在个人主页查看结果",4e3)})},t.uploadFile=function(){if(!t.$currentUser)return t.$emit("auth:loginRequired");var e=this.$parent;t.result[e.$index]={};var i=document.getElementById("file").files[0];if(i){var r=t.tem;s.file(i,"user",t.$currentUser.id).success(function(i){t.result[e.$index].name=r,t.result[e.$index].url=i.url})}},t.submitVoteResult=function(){var e=[];if(!t.$currentUser)return t.$emit("auth:loginRequired");if(t.activity.verifyRule&&!t.activity.verifyId)return void Materialize.toast("验证规则必须填",2e3);for(var r in t.result)t.result[r]&&e.push(t.vote._voteItems[r].id);if(t.vote.limit&&e.length<t.vote.limit)return void Materialize.toast("必须选择"+t.vote.limit+"项哦",2e3);if(t.vote.max&&e.length>t.vote.max)return void Materialize.toast("只能选择"+t.vote.max+"项哦",2e3);if(e.length<=0)return void Materialize.toast("至少选择一项哦",2e3);var a={verifyId:t.activity.verifyId,voteId:t.vote.id,created:new Date,result:e};i.prototype_create_voteResults({id:t.$currentUser.id},a,function(t){1e3===t.status?Materialize.toast(t.message,2e3):Materialize.toast("参与成功,可在个人主页查看结果",4e3)})},t.submitSeckillResult=function(){if(!t.$currentUser)return t.$emit("auth:loginRequired");if(t.activity.verifyRule&&!t.activity.verifyId)return void Materialize.toast("验证规则必须填",2e3);var e={created:new Date,verifyId:t.activity.verifyId,itemId:this.seckillItem.id,seckillId:t.seckill.id};i.prototype_create_seckillResults({id:t.$currentUser.id},e,function(t){1e3===t.status||1100===t.status?Materialize.toast(t.message,2e3):Materialize.toast("参与成功,可在个人主页查看结果",4e3)})}}]);
app.config(["$stateProvider","$urlRouterProvider",function(t,i){i.when("","/application/views/activity/index.html"),t.state("art.activities",{url:"/activities",controller:"ActivitiesController",templateUrl:"/application/views/activity/index.html"}).state("art.activity",{url:"/:id/detail",controller:"ActivityDetailController",templateUrl:"/application/views/activity/detail.html"}).state("activity",{url:"/w/activities/:id",controller:"ActivityController",templateUrl:"application/views/activity/detail.html"})}]);
app.controller("CoteriesController",["$scope","User","Coterie","$location",function(e,t,r,i){function o(){t.prototype_get_coteries({id:e.$currentUser.id},function(t){e.coteries=t,t.length&&!i.path().match(/\/w\/coteries\/.+/)&&i.path("/w/coteries/"+e.coteries[0].id)})}e.more=!1,e.moreOrBack=e.more?"返回":"发现",e.goLogin=function(){return e.$currentUser?void 0:e.$emit("auth:loginRequired")},e.moreCoteries=function(){if(e.more=!e.more,e.more)r.find(function(t){e.coteries=t});else{if(!e.$currentUser)return e.$emit("auth:loginRequired");o()}e.moreOrBack=e.more?"返回":"发现"},e.$currentUser&&o()}]),app.controller("CoterieController",["$scope","$stateParams","Coterie","User","Ueditor","$http","$location",function(e,t,r,i,o,n,c){r.findById({id:t.id},function(r){e.coterie=r,e.$emit("shareContentArrive",{bdText:r.name,bdPic:r.logoUrl}),r.isAttentioned&&i.prototype_updateById_coteries({id:e.$currentUser.id,fk:t.id},{lastView:new Date},function(e){},function(e){console.log(e)})}),r.prototype_get_articles({id:t.id},function(t){e.articles=t},function(){}),e.editorConfig=o.config,e.article={},e.createArticle=function(){if(!e.$currentUser)return e.$emit("auth:loginRequired");var r=e.articleEditorContent,o=e.article.title;return r&&o?void n({url:"/ue/uploads?dir=user&id="+e.$currentUser.id+"&action=uploadtext",method:"post",data:{content:e.articleEditorContent}}).success(function(r){e.article.contentUrl=r.url,e.article.created=new Date,e.article.coterieId=t.id,i.prototype_create_articles({id:e.$currentUser.id},e.article,function(e){console.log(e),Materialize.toast("文章发布成功",2e3),c.path("/w/coteries/"+t.id)})}):void Materialize.toast("文章标题和内容都不能为空",2e3)},e.attention=function(){return e.$currentUser?void i.prototype_create_coteries({id:e.$currentUser.id},{lastView:new Date,coterieId:t.id},function(t){e.coterie.isAttentioned=!0,Materialize.toast("关注成功！",2e3)},function(e){console.log(e),Materialize.toast("关注失败！",2e3)}):e.$emit("auth:loginRequired")},e.addLike=function(){if(!e.$currentUser)return e.$emit("auth:loginRequired");var t=this.article;i.prototype_create_likeUsers({id:e.$currentUser.id},{articleId:t.id,created:new Date},function(e){1===e.status?(t.likeCount++,t.islike=!0,Materialize.toast("文章标记为喜欢",2e3)):Materialize.toast("文章已经被标记为喜欢",2e3)})}}]),app.controller("ArticlesController",["$scope","Article",function(e,t){e.loadComment=function(){var e=this.article;return this.article.commentTextarea=!0,e.showCommentBox?void(e.showCommentBox=!1):(t.prototype_get_comments({id:e.id},function(t){e.comments=t}),void(e.showCommentBox=!0))}}]),app.controller("CommentsController",["$scope","Comment","User",function(e,t,r){e.createComment=function(){var t=this.article;return e.$currentUser?t.writingCommentContent?void r.prototype_create_comments({id:e.$currentUser.id},{articleId:t.id,created:new Date,content:t.writingCommentContent},function(r){r.user={headImgUrl:e.$currentUser.headImgUrl,id:e.$currentUser.id,name:e.$currentUser.name},t.commentCount++,r.replyCount=0,t.comments.push(r),t.writingCommentContent=null,Materialize.toast("评论成功",2e3)}):void Materialize.toast("请先输入评论内容",2e3):e.$emit("auth:loginRequired")},e.loadReply=function(){var e=this.comment;t.prototype_get_replys({id:this.comment.id},function(t){e.replys=t})},e.createReply=function(){var t=this.comment;return e.$currentUser?t.writingReplyContent?void r.prototype_create_replys({id:e.$currentUser.id},{commentId:t.id,created:new Date,content:t.writingReplyContent},function(r){r.user={id:e.$currentUser.id,name:e.$currentUser.name},t.replyCount++,t.replys.push(r),t.writingReplyContent=null,Materialize.toast("回复成功",2e3)}):void Materialize.toast("请先输入回复内容",2e3):e.$emit("auth:loginRequired")}}]),app.controller("ArticleController",["$scope","$stateParams","User","Coterie","Article","Comment",function(e,t,r,i,o,n){e.$currentUser||(e.$currentUser={},e.$currentUser.id=0),o.findById({id:t.id},function(r){e.article=r,e.$emit("shareContentArrive",{bdText:r.title}),o.prototype_get_comments({id:t.id},function(t){e.article.comments=t}),e.article.showCommentBox=!0}),o.prototype_create_readers({id:t.id},{userId:e.$currentUser.id,form:"pc"})}]);
app.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("coteries",{url:"/w/coteries",controller:"CoteriesController",templateUrl:"application/views/coterie/index.html"}).state("coteries.articles",{url:"/:id",controller:"CoterieController",templateUrl:"application/views/coterie/detail.html"}).state("edit",{url:"/w/articles/:id/edit",controller:"CoterieController",templateUrl:"application/views/coterie/edit.html"}).state("coterie",{url:"/w/coteries/:id/articles",controller:"CoterieController",templateUrl:"application/views/coterie/detail.html"}).state("article",{url:"/w/articles/:id",controller:"ArticleController",templateUrl:"application/views/coterie/article.html"})}]);
app.controller("RacesController",["$scope","Race","$window",function(e,t,i){i.pull=!0,e.raceItems=[],e.filterBar="ng-hide";var r=0;angular.element(i).bind("scroll",function(t){var r=t.target.body;r.scrollHeight-r.clientHeight-r.scrollTop<600&&i.pull?(e.getRaces(),i.pull=!1):r.scrollHeight-r.clientHeight-r.scrollTop>600&&(i.pull=!0)}),e.$on("$destroy",function(t,r){angular.element(i).unbind("scroll"),e.raceItems=void 0}),e.getRaces=function(){return e.$currentUser?void t.getMySchoolRaces({school:e.$currentUser.school,page:r},function(t){for(x in t)"races"===x&&((t[x].length<16||0===t[x].length)&&(e.last=!0),e.raceItems.push.apply(e.raceItems,t[x]),r++)}):void e.$emit("auth:loginRequired")},e.titleFilter=function(){this.filterTitle?e.query={name:this.filterTitle}:e.query=void 0},e.username?e.getRaces():t.find(function(t){e.raceItems=t})}]),app.controller("RaceController",["$scope","Race","$stateParams","User","Team",function(e,t,i,r,n){t.findById({id:i.id},function(t){e.race=t,e.$emit("shareContentArrive",{bdText:t.name,bdPic:t.imgUrl})}),t.prototype_get_materials({id:i.id},function(t){e.materials=t},function(){Materialize.toast("获取资料列表失败！",2e3)}),t.prototype_get_notices({id:i.id},function(t){e.notices=t}),t.prototype_get_raceTeams({id:i.id},function(t){e.raceTeams=t}),e.$currentUser&&r.prototype_get_teams({id:e.$currentUser.id},function(t){e.teams=t}),e.selectedTeam=function(){e.selected=this.team.id},e.joinRace=function(){return e.$currentUser?e.selected?void n.prototype_link_partakedRaces({id:e.selected,fk:i.id},{},function(e){Materialize.toast("参与成功,请经常关注竞赛信息",2e3)}):Materialize.toast("必须选择一个团队",2e3):e.$emit("auth:loginRequired")}}]);
app.config(["$stateProvider","$urlRouterProvider",function(e,r){e.state("art.races",{url:"/races",controller:"RacesController",templateUrl:"application/views/race/index.html"}).state("race",{url:"/w/races/:id",controller:"RaceController",templateUrl:"application/views/race/detail.html"})}]);
app.controller("TeamsController",["$scope","Team","User","$location","uploadFile","$window",function(e,t,a,n,i,o){e.filterBar="ng-hide",e.types=[{name:"校园组织"},{name:"校园团队"},{name:"兴趣团队"},{name:"竞赛团队"}],o.pull=!0,e.teams=[];var r=0;angular.element(o).bind("scroll",function(t){var a=t.target.body;a.scrollHeight-a.clientHeight-a.scrollTop<600&&o.pull&&!e.last?(e.getTeams(),o.pull=!1):a.scrollHeight-a.clientHeight-a.scrollTop>600&&(o.pull=!0)}),e.$on("$destroy",function(t,a){angular.element(o).unbind("scroll"),e.teams=void 0}),e.team={status:!1,hidden:!1},e.allStatusFilter=function(){e.query=void 0,e.status="状态"},e.statusFilter=function(){e.query={status:1},r=0,e.last=!1,e.teams=[],e.getTeams(),e.status="可加入"},e.organizationFilter=function(){e.query={type:"校园组织"},r=0,e.last=!1,e.teams=[],e.getTeams(),e.typeHide=!0,e.type="校园组织"},e.associationFilter=function(){e.query={type:"校园社团"},r=0,e.last=!1,e.teams=[],e.getTeams(),e.typeHide=!0,e.type="校园社团"},e.avocationFilter=function(){e.query={type:"兴趣团队"},r=0,e.last=!1,e.teams=[],e.getTeams(),e.typeHide=!0,e.type="兴趣团队"},e.raceFilter=function(){e.query={type:"竞赛团队"},r=0,e.last=!1,e.teams=[],e.getTeams(),e.typeHide=!0,e.type="竞赛团队"},e.allTypeFilter=function(){e.query=void 0,e.typeHide=!0,e.type="团队类型"},e.titleFilter=function(){this.filterTitle?e.query={name:this.filterTitle}:e.query=void 0},e.uploadLogo=function(){if(!e.$currentUser)return e.$emit("auth:loginRequired");var t=document.getElementById("teamlogo").files[0],a=(new XMLHttpRequest,/\.[^\.]+/.exec(document.getElementById("teamlogo").value.toLowerCase()));return".png"!==a[0]&&".jpg"!==a[0]&&".jpeg"!==a[0]&&".gif"!==a[0]?(alert("请确认您上传的logo文件格式是jpg、png、gif或jpeg"),!1):void i.img(t,"teamlogo",e.$currentUser.id).success(function(t){e.team.logoUrl=t.url})},e.getTeams=function(){if(!e.$currentUser)return void e.$emit("auth:loginRequired");var a=e.query||{};t.getMySchoolTeams({school:e.$currentUser.school,page:r,type:a.type,status:a.status},function(t){(t.teams.length<16||0===t.teams.length)&&(e.last=!0),r++,e.teams.push.apply(e.teams,t.teams)})},e.username?e.getTeams():t.find(function(t){e.teams=t}),e.createTeam=function(){return e.$currentUser?e.team.logoUrl?void a.prototype_create_teams({id:e.$currentUser.id},e.team,function(e){Materialize.toast("创建团队成功",2e3),n.path("/w/teams/"+e.id)}):Materialize.toast("团队logo未上传成功,请稍等",2e3):e.$emit("auth:loginRequired")}}]),app.controller("TeamController",["$scope","Team","$stateParams","User","$location","$timeout",function(e,t,a,n,i,o){function r(e){var t=new Date;try{new Date(e.ended)<t?e.status="end":new Date(e.started)>t?e.status="nos":e.status="ing"}catch(a){}}e.userInfomation={},e.teamId||(e.teamId=a.id),t.findById({id:e.teamId},function(t){e.team=t,e.$emit("shareContentArrive",{bdText:t.name,bdPic:t.logoUrl,bdDesc:t.desc})},function(){}),t.prototype_get_activities({id:e.teamId},function(t){e.activities=t,e.activities.forEach(function(e){r(e)})}),e.getUserInfo=function(){return e.$currentUser?void n.getInfo(function(t){e.user=t,t.studentId||(Materialize.toast("加入团队需要验证学号信息",2e3),o(function(){i.path("/u/confirmSchool")},1e3))}):e.$emit("auth:loginRequired")},e.join=function(){return e.$currentUser?void t.prototype_create_members({id:e.teamId},e.userInfomation,function(e){Materialize.toast("申请成功,等待管理员同意",2e3)},function(e){console.log(e),Materialize.toast(e.data.error.message,2e3)}):e.$emit("auth:loginRequired")}}]);
app.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("art.teams",{url:"/teams",controller:"TeamsController",templateUrl:"application/views/team/index.html"}).state("create",{url:"/w/teams/create",controller:"TeamsController",templateUrl:"application/views/team/create.html"}).state("team",{url:"/w/teams/:id",controller:"TeamController",templateUrl:"application/views/team/detail.html"})}]);
function createQrcode(e,t){document.getElementById(t).innerHTML=null;new QRCode(document.getElementById(t),{text:e,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M})}function userAuthSave(e,t,o){e.user.id=e.userId,t.cancelLogin(),e.user.accessToken=e.id,t.$currentUser=e.user,t.username=e.user.name,o.setUser(e.id,e.userId,e.user),o.save(),localStorage.$LoopBack$currentUserToken=JSON.stringify(e)}function auth2wechat(e,t,o,r,n,i){e.auth2wechat({code:o.code,state:o.state,action:o.action},function(e){t.user=e.token.user,t.aouth=e.aouth,"未知"===t.user.school&&(t.user.school="杭州电子科技大学"),userAuthSave(e.token,r,i),Materialize.toast("登录成功",2e3),t.aouth.iswechat&&n.path(t.aouth.url)},function(e){t.err=e,t.status="fail"})}app.controller("LoginController",["User","Aouth","$scope","$location","LoopBackAuth","$window","$rootScope","$http","$interval","$timeout",function(e,t,o,r,n,i,c,a,s,u){o.user={},o.loadURL=function(){var e=(i.location.href,"micromessenger"==navigator.userAgent.toLowerCase().match(/MicroMessenger/i));return c.mediaIsPC||e?void a.get("/wechatUrl?iswechat="+e+"&url="+r.path()).success(function(a){if(o.wechatLogin=c.mediaIsPC,e)i.location.href=a.url;else{createQrcode(a.url,"qrcode");var l=!0,d=s(function(){t.findById({id:a.token},function(e){var t=e.token;t&&(s.cancel(d),"未知"===t.user.school&&(t.user.school="杭州电子科技大学",t.user.isVerify=!1),userAuthSave(t,c,n),o.wechatLogin=!1,Materialize.toast("登录成功",3e3),l=!1,e.aouth.url?Materialize.toast("记得去完善资料",3e3):r.path("/u/info"))})},3e3);u(function(){l&&(Materialize.toast("验证超时，请在30秒内完成确认哦",3e3),document.getElementById("qrcode").innerHTML=null,o.wechatLogin=!1,t.deleteById({id:a.token}),s.cancel(d))},3e4)}}).error(function(e){console.log(e)}):void Materialize.toast("只能在微信中微信登录噢",3e3)},o.login=function(){o.user.password=hex_md5(o.user.password),e.login(o.user,function(e){userAuthSave(e,c,n),Materialize.toast("登录成功",2e3)},function(e){Materialize.toast("登录失败,请检查输入是否正确",2e3)})}}]),app.controller("OrgLoginController",["User","$scope","$location","LoopBackAuth","$rootScope",function(e,t,o,r,n){t.login=function(){e.login(t.user,function(e){userAuthSave(e,n,r),Materialize.toast("登录成功",2e3)})},t.resetPassword=function(){e.resetPassword({lastPwd:t.lastPwd,newPwd:hex_md5(t.newPwd)},function(e){Materialize.toast("密码修改成功,请记住新密码",2e3),o.path("/u/info")})}}]),app.controller("RegisterController",["User","School","$scope","$rootScope","$location","LoopBackAuth",function(e,t,o,r,n,i){o.user={},t.find(function(e){o.schools=e}),o.register=function(){o.user.password=hex_md5(o.user.password),e.create(o.user,function(e){userAuthSave(e,r,i),Materialize.toast("恭喜你，注册成功",2e3);var t="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx5d92b3c192f993e7&redirect_uri=http://"+n.host()+"/u/bind&response_type=code&scope=snsapi_userinfo&state="+e.userId+"#wechat_redirect";createQrcode(t,"bindQrcode"),o.regSuccess=!0},function(e){1e3===e.status&&Materialize.toast("该手机号已经被注册",2e3)})}}]),app.controller("ConfirmSchoolController",["User","$scope","School","$window",function(e,t,o,r){t.user=t.$currentUser,o.findOne({filter:{where:{name:t.$currentUser.school},fields:["academy"]}},function(e){t.academies=e[0].academy}),t.confirm=function(){e.confirmSchool({id:t.$currentUser.id},{studentId:t.studentId,password:hex_md5(t.studentPassword),academy:t.academy},function(e){t.$currentUser.studentId=studentId,Materialize.toast("验证成功",2e3),r.history.back()})}}]),app.controller("UserController",["$scope","User","$rootScope","$location",function(e,t,o,r){var n=function(){t.getMyTeams({id:e.$currentUser.id},function(t){e.teams=t.teams})},i=function(){t.getRaceHistories({id:e.$currentUser.id},function(t){e.races=t.races})},c=function(){t.getActivitiesHistories({id:e.$currentUser.id},function(t){e.activities=t.activities})},a=function(){t.getLikeArticles({id:e.$currentUser.id},function(t){e.likeArticles=t.articles})},s=function(){t.prototype_get_articles({id:e.$currentUser.id},function(t){e.articles=t})};e.goLogin=function(){return e.$currentUser?void 0:e.$emit("auth:loginRequired")},e.activeMenus=[{name:"我的团队",clickFn:n,active:!0,eName:"team"},{clickFn:i,name:"参赛竞赛",active:!1,eName:"race"},{clickFn:c,name:"活动历史",active:!1,eName:"activity"},{clickFn:a,name:"喜欢文章",active:!1,eName:"article"}],e.logout=function(){o.$currentUser=null,localStorage.$LoopBack$currentUserToken="",localStorage.$LoopBack$accessTokenId="",o.username=!1,Materialize.toast("退出成功",2e3),r.path("/w/activities")},e.pullData=function(){return e.$currentUser?(e.activeMenus.forEach(function(e){e.active=!1}),this.menu.active=!0,this.menu.clickFn(),void(e.selectedMenu=this.menu.eName)):e.$emit("auth:loginRequired")},e.selectedMenu="team",e.$currentUser?(e.user=e.$currentUser,n(),s()):e.user=null}]),app.controller("AuthController",["$scope","User","$location","$rootScope","LoopBackAuth",function(e,t,o,r,n){var i="micromessenger"==navigator.userAgent.toLowerCase().match(/MicroMessenger/i),c=o.search();c.action="login",i&&c.code?(auth2wechat(t,e,c,r,o,n),o.search({})):e.status="fail",e.goLogin=function(){e.$emit("auth:loginRequired")}}]),app.controller("BindController",["$scope","User","$location","$rootScope","LoopBackAuth",function(e,t,o,r,n){var i="micromessenger"==navigator.userAgent.toLowerCase().match(/MicroMessenger/i),c=o.search();c.action="bind",i&&c.code?(auth2wechat(t,e,c,r,o,n),o.search({})):e.status="fail"}]),app.controller("UserInfoController",["$scope","User","School","$location","uploadFile",function(e,t,o,r,n){e.$currentUser?(t.getInfo(function(t){delete t.$promise,delete t.$resolved,e.user=t}),o.find(function(t){e.schools=t})):(e.$emit("auth:loginRequired"),e.user=null),e.uploadLogo=function(){if(!e.$currentUser)return e.$emit("auth:loginRequired");var t=document.getElementById("headImg").files[0];n.img(t,"headImgUrl",e.$currentUser.id).success(function(t){e.user.headImgUrl=t.url})},e.bindWechat=function(){var t="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx5d92b3c192f993e7&redirect_uri=http://"+r.host()+"/u/bind&response_type=code&scope=snsapi_userinfo&state="+e.$currentUser.id+"#wechat_redirect";createQrcode(t,"bindQrcode")},e.updateInfo=function(){t.prototype_updateAttributes(e.user,function(e){Materialize.toast("修改成功",2e3)})},e.resetPassword=function(){t.resetPassword({lastPwd:hex_md5(e.lastPwd),newPwd:hex_md5(e.newPwd)},function(e){Materialize.toast("修改成功,请记住新密码",2e3)})}}]),app.controller("RetController",["$scope",function(e){}]),app.controller("ActivityResultController",["$scope","$stateParams","User",function(e,t,o){return e.$currentUser?(e.type=t.type,void o["prototype_findById_"+t.type+"Results"]({id:e.$currentUser.id,fk:t.id},function(t){e.results=t.results,e.activity=t.activity})):e.$emit("auth:loginRequired")}]),app.controller("MSController",["User","$stateParams",function(e,t){window.localStorage.$LoopBack$currentTeamId=t.id,window.location.href="/MS"}]),app.controller("ARTController",["$scope",function(){}]);
app.config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("confirmSchool",{url:"/u/confirmSchool",controller:"ConfirmSchoolController",templateUrl:"application/views/confirm-school.html"}).state("register",{url:"/u/register",controller:"RegisterController",templateUrl:"application/views/user/register.html"}).state("index",{url:"/",controller:"HomeController",templateUrl:"/application/views/index.html"}).state("home",{url:"/u/home",controller:"UserController",templateUrl:"/application/views/user/index.html"}).state("info",{url:"/u/info",controller:"UserInfoController",templateUrl:"/application/views/user/info.html"}).state("retrieve",{url:"/u/retrieve",controller:"RetController",templateUrl:"/application/views/user/retrieve.html"}).state("auth",{url:"/u/auth",controller:"AuthController",templateUrl:"/application/views/user/auth.html"}).state("bind",{url:"/u/bind",controller:"BindController",templateUrl:"/application/views/user/bind.html"}).state("activityResult",{url:"/u/results/:id/:type",controller:"ActivityResultController",templateUrl:"/application/views/user/activity-result.html"}).state("orgLogin",{url:"/u/orgLogin",controller:"OrgLoginController",templateUrl:"/application/views/user/org-user-login.html"}).state("MS",{url:"/w/team/:id",controller:"MSController",template:"<div></div>"}).state("art",{url:"/w",controller:"ARTController",template:"<div ui-view></div>"})}]);